/**
 * websocket-sample
 */

var http = require("http");
var fs = require ('fs');
var WebSocketServer = require('websocket').server;

function handler (request, response) {
	// This handler function will be run in response
	// to any HTTP request.
	fs.readFile(__dirname + '/websocket-sample.html',
	function (error, data) {
		if (error) {
			response.writeHead(500);
			return response.end('Error loading websocket-sample.html');
		}
		response.writeHead(200);
		response.end(data);
	});
}

// Create a basic HTTP server object
var app = http.createServer(handler);

// Start the server listening on port 8080
app.listen (8080, function() {
	console.log((new Date()) + " Server is listening on port 8080");
});

wsServer = new WebSocketServer({
	// The WebSocket-Node module is designed to extend an existing HTTP
	// server; the HTTP server object is passed on the WebSocket as a parameter
	httpServer: app
});

// This handler function will be run in response to any WebSocket requests
wsServer.on ('request', function (request) {
	var connection = request.accept (null, request.origin);
	console.log((new Date()) + " Connection accepted.");
	connection.on('message', function (message) {
		console.log("Received Message: " + message.utf8Data);
		// The handler will echo any message received back
		// to the socket it was received from.
		connection.sendUTF (message.utf8Data);
	})
})